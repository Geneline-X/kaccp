generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// KACCP V2: Speech Synthesis Data Collection Platform
// ============================================================================

model Session {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  expiresAt    DateTime
  userId       String
  sessionToken String   @unique
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([expiresAt])
}

model Notification {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  readAt    DateTime?
  userId    String
  type      String
  title     String
  body      String?
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

// ============================================================================
// USER MODEL - Updated for V2
// ============================================================================

model User {
  id           String    @id @default(cuid())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  email        String    @unique
  passwordHash String
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  resetToken       String?   @unique
  resetTokenExpiry DateTime?
  displayName  String?
  role         UserRole  @default(SPEAKER) // Primary role (for backward compatibility)
  roles        UserRole[] // Multiple roles a user can have (e.g., [SPEAKER, TRANSCRIBER])
  phone        String?   @unique
  avatarUrl    String?
  bio          String?

  // Language capabilities
  speaksLanguages String[] // Language codes they can speak (e.g., ["kri", "men"])
  writesLanguages String[] // Language codes they can write/transcribe

  // Stats
  qualityScore        Float @default(0)
  totalEarningsCents  Int   @default(0)
  totalRecordingsSec  Float @default(0)
  totalTranscriptions Int   @default(0)

  // Relations
  notifications Notification[]
  payments      Payment[]
  sessions      Session[]
  walletTxns    WalletTransaction[]

  // V2 Relations
  speakerRecordings        Recording[]               @relation("SpeakerRecordings")
  transcriberWork          Transcription[]           @relation("TranscriberWork")
  reviewerWork             Transcription[]           @relation("ReviewerWork")
  transcriptionAssignments TranscriptionAssignment[]
}

// ============================================================================
// V2 CORE MODELS: Country, Language, Prompt, Recording, Transcription
// ============================================================================

model Country {
  id        String     @id @default(cuid())
  code      String     @unique // ISO 3166-1 alpha-2: SL, GN, LR, etc.
  name      String // Sierra Leone, Guinea, Liberia
  isActive  Boolean    @default(true)
  languages Language[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model Language {
  id         String  @id @default(cuid())
  code       String  @unique // ISO 639-3: kri, men, tem, sus, etc.
  name       String // Krio, Mende, Temne, Susu
  nativeName String? // How it's called in the language
  countryId  String
  country    Country @relation(fields: [countryId], references: [id])
  isActive   Boolean @default(true)

  // Targets and progress (in minutes)
  targetMinutes    Int   @default(12000) // 200 hours = 12000 min
  collectedMinutes Float @default(0)
  approvedMinutes  Float @default(0)

  // Incentive rates (SLE - Leones)
  speakerRatePerMinute  Float @default(2.5)
  transcriberRatePerMin Float @default(1.5)

  includeUniversalPrompts Boolean @default(true) // Whether to mix in generic prompts (languageId=null)

  prompts    Prompt[]
  recordings Recording[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  @@index([countryId])
  @@index([isActive])
}

model Prompt {
  id                String         @id @default(cuid())
  languageId        String?
  language          Language?      @relation(fields: [languageId], references: [id])

  // English text that speaker translates and speaks
  englishText       String
  category          PromptCategory          // Scenario category
  emotion           PromptEmotion  @default(NEUTRAL)
  instruction       String?                 // Extra guidance: "Say with excitement"

  targetDurationSec Int            @default(5)   // Expected: 3-10 seconds
  isActive          Boolean        @default(true)
  timesRecorded     Int            @default(0)

  recordings        Recording[]
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([languageId, category])
  @@index([languageId, isActive])
}

model Recording {
  id         String   @id @default(cuid())
  promptId   String
  prompt     Prompt   @relation(fields: [promptId], references: [id])
  speakerId  String
  speaker    User     @relation("SpeakerRecordings", fields: [speakerId], references: [id])
  languageId String
  language   Language @relation(fields: [languageId], references: [id])

  // Audio file (GCS: /{country}/{language}/recordings/{speakerId}/{id}.wav)
  audioUrl    String
  durationSec Float // Max 10 seconds enforced by UI
  fileSize    Int?
  sampleRate  Int? // Target: 16000 Hz

  status RecordingStatus @default(PENDING_TRANSCRIPTION)

  // Quality flags (set by transcriber)
  isFlagged  Boolean @default(false)
  flagReason String? // NOISE, UNCLEAR, TOO_QUIET, WRONG_LANGUAGE

  // Kay X Auto-Transcription (AI-generated Krio transcript)
  transcript              String? // Auto-generated Krio transcript from Kay X
  transcriptConfidence    Float? // Confidence score (0-1)
  autoTranscriptionStatus AutoTranscriptionStatus @default(PENDING)
  autoTranscribedAt       DateTime?
  transcriptMetadata      Json? // Additional Kay X response data

  // Consent
  consentGiven Boolean @default(true)

  // Metadata
  deviceInfo String?

  transcription Transcription?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([languageId, status])
  @@index([speakerId])
  @@index([status])
  @@index([autoTranscriptionStatus])
}

model Transcription {
  id            String    @id @default(cuid())
  recordingId   String    @unique
  recording     Recording @relation(fields: [recordingId], references: [id])
  transcriberId String
  transcriber   User      @relation("TranscriberWork", fields: [transcriberId], references: [id])

  // The written transcription (exactly what was said)
  text String

  status TranscriptionStatus @default(PENDING_REVIEW)

  // Review
  reviewerId  String?
  reviewer    User?     @relation("ReviewerWork", fields: [reviewerId], references: [id])
  reviewedAt  DateTime?
  reviewNotes String?

  submittedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([transcriberId])
  @@index([status])
}

// Assignment system for transcribers (claim recordings)
model TranscriptionAssignment {
  id          String    @id @default(cuid())
  recordingId String
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  expiresAt   DateTime
  releasedAt  DateTime?
  createdAt   DateTime  @default(now())

  @@index([userId, releasedAt])
  @@index([expiresAt])
  @@index([recordingId])
}

// ============================================================================
// PAYMENT MODELS (kept from V1)
// ============================================================================

model PaymentRatePlan {
  id                 String   @id @default(cuid())
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  name               String   @unique
  ratePerMinuteCents Int
  currency           Currency @default(SLE)
  active             Boolean  @default(true)
}

model Payment {
  id                 String              @id @default(cuid())
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  userId             String
  amountCents        Int
  currency           Currency            @default(SLE)
  status             PaymentStatus       @default(PENDING)
  reference          String?
  notes              String?
  user               User                @relation(fields: [userId], references: [id])
  walletTransactions WalletTransaction[]
}

model WalletTransaction {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  userId           String
  deltaCents       Int
  description      String?
  relatedPaymentId String?
  relatedPayment   Payment? @relation(fields: [relatedPaymentId], references: [id])
  user             User     @relation(fields: [userId], references: [id])
}

// V2 Export tracking
model ExportRecord {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  languageId    String
  languageCode  String
  recordingId   String   @unique
  audioPath     String
  transcription String
  durationSec   Float
  speakerId     String

  @@index([languageId])
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  ADMIN
  SPEAKER
  TRANSCRIBER
  REVIEWER
}

enum RecordingStatus {
  PENDING_TRANSCRIPTION // Waiting for transcriber to claim
  TRANSCRIBED // Has transcription, pending review
  APPROVED // Ready for TTS export
  REJECTED // Quality issues, won't be used
  FLAGGED // Transcriber flagged, needs admin review
}

enum TranscriptionStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
}

enum Currency {
  USD
  SLE
  GNF   // Guinean Franc
  LRD   // Liberian Dollar
}

// Prompt categories (scenarios for speakers)
enum PromptCategory {
  GREETINGS           // "Good morning", "How are you?"
  NUMBERS_MONEY       // "One hundred", "The price is fifty thousand"
  QUESTIONS           // "What is your name?", "Where is the market?"
  COMMANDS_REQUESTS   // "Come here", "Please help me"
  EMOTIONS_HAPPY      // "I am so happy!", "This is wonderful!"
  EMOTIONS_SAD        // "I am very sad", "This makes me angry"
  DAILY_LIFE          // "I'm going to work", "The food is ready"
  MARKET_SHOPPING     // "How much?", "Too expensive"
  DIRECTIONS_PLACES   // "Turn left", "Near the school"
  FAMILY_PEOPLE       // "My mother is home", "The children are playing"
  HEALTH              // "I feel sick", "Where is the hospital?"
  WEATHER_TIME        // "It's raining", "Tomorrow morning"
  LOCAL_SCENARIOS     // Sierra Leone specific situations
  PHONETIC_COVERAGE   // Words covering all sounds
  CONVERSATIONS       // Short dialogue lines
}

enum PromptEmotion {
  NEUTRAL
  HAPPY
  SAD
  ANGRY
  QUESTION
  EXCITED
  SURPRISED
  WHISPER
  URGENT
}

enum AutoTranscriptionStatus {
  PENDING // Not yet auto-transcribed
  COMPLETED // Kay X successfully transcribed
  FAILED // Transcription failed (error or service unavailable)
  SKIPPED // Skipped (non-Krio, Kay X disabled, or unsupported format)
}
